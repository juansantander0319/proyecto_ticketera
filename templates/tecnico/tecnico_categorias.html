{% extends "base.html" %}

{% block title %}Gestión de Categorías - Ticketera{% endblock %}

{% block content %}
<div class="container-fluid fade-in">
    <h2 class="mt-4"><i class="bi bi-tags-fill"></i> Gestión de Categorías y SLAs</h2>
    <p class="text-muted">Administra las categorías de tickets y define los tiempos de respuesta y solución.</p>

    <div class="mb-3 text-end">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevaCategoria">
            <i class="bi bi-plus-circle"></i> Nueva Categoría
        </button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Descripción</th>
                            <th>SLA Respuesta</th>
                            <th>SLA Resolución</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cat in categorias %}
                        <tr>
                            <td>{{ cat.nombre }}</td>
                            <td>{{ cat.descripcion }}</td>
                            <td>{{ cat.sla_respuesta }}h</td>
                            <td>{{ cat.sla_resolucion }}h</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary edit-btn"
                                        data-bs-toggle="modal" data-bs-target="#modalEditarCategoria"
                                        data-id="{{ cat.id }}"
                                        data-nombre="{{ cat.nombre }}"
                                        data-descripcion="{{ cat.descripcion }}"
                                        data-sla-respuesta="{{ cat.sla_respuesta }}"
                                        data-sla-resolucion="{{ cat.sla_resolucion }}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-btn" 
                                        data-bs-toggle="modal" data-bs-target="#modalEliminarCategoria"
                                        data-id="{{ cat.id }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNuevaCategoria" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Nueva Categoría</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('tecnico_categorias') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3"><label for="nombre" class="form-label">Nombre</label><input type="text" class="form-control" name="nombre" required></div>
                    <div class="mb-3"><label for="descripcion" class="form-label">Descripción</label><textarea class="form-control" name="descripcion" rows="2"></textarea></div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label for="sla_respuesta" class="form-label">SLA Respuesta (horas)</label><input type="number" class="form-control" name="sla_respuesta" min="1" required></div>
                        <div class="col-md-6 mb-3"><label for="sla_resolucion" class="form-label">SLA Resolución (horas)</label><input type="number" class="form-control" name="sla_resolucion" min="1" required></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarCategoria" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Editar Categoría</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('editar_categoria') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="id_categoria_edit" id="id_categoria_edit">
                    <div class="mb-3"><label for="nombre_edit" class="form-label">Nombre</label><input type="text" class="form-control" name="nombre_edit" id="nombre_edit" required></div>
                    <div class="mb-3"><label for="descripcion_edit" class="form-label">Descripción</label><textarea class="form-control" name="descripcion_edit" id="descripcion_edit" rows="2"></textarea></div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label for="sla_respuesta_edit" class="form-label">SLA Respuesta (horas)</label><input type="number" class="form-control" name="sla_respuesta_edit" id="sla_respuesta_edit" min="1" required></div>
                        <div class="col-md-6 mb-3"><label for="sla_resolucion_edit" class="form-label">SLA Resolución (horas)</label><input type="number" class="form-control" name="sla_resolucion_edit" id="sla_resolucion_edit" min="1" required></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Actualizar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEliminarCategoria" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('eliminar_categoria') }}" method="POST">
                <div class="modal-body">
                    <p>¿Estás seguro de que quieres eliminar esta categoría? Esta acción no se puede deshacer.</p>
                    <input type="hidden" name="id_categoria_delete" id="id_categoria_delete">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Script para rellenar el modal de edición
    var editModal = document.getElementById('modalEditarCategoria');
    editModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        document.getElementById('id_categoria_edit').value = button.getAttribute('data-id');
        document.getElementById('nombre_edit').value = button.getAttribute('data-nombre');
        document.getElementById('descripcion_edit').value = button.getAttribute('data-descripcion');
        document.getElementById('sla_respuesta_edit').value = button.getAttribute('data-sla-respuesta');
        document.getElementById('sla_resolucion_edit').value = button.getAttribute('data-sla-resolucion');
    });

    // Script para rellenar el modal de eliminación
    var deleteModal = document.getElementById('modalEliminarCategoria');
    deleteModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        document.getElementById('id_categoria_delete').value = button.getAttribute('data-id');
    });
});
</script>
{% endblock %}