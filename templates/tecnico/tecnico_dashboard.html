{% extends "base.html" %}

{% block title %}Información General - Ticketera{% endblock %}

{% block content %}
<div class="container-fluid fade-in">
  <main class="px-md-4 py-4">
    <h2 class="mb-1"><i class="bi bi-speedometer2"></i> Información General</h2>
    <p class="text-muted mb-0">Vista general de tickets y métricas clave del sistema</p>

    <!-- NUEVO: Alerta de Feriado -->
    {% if es_feriado %}
    <div class="alert alert-info mt-3 shadow-sm border-info" role="alert">
        <h5 class="alert-heading"><i class="bi bi-calendar-event"></i> ¡Hoy es Feriado o Fin de Semana!</h5>
        <p class="mb-0">El sistema ha detectado que hoy es un día no hábil según la API del Gobierno. Los SLAs de los tickets nuevos se ajustarán automáticamente.</p>
    </div>
    {% endif %}

    <div class="row my-4">
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card border-danger shadow-sm h-100">
          <div class="card-body">
            <h6 class="card-title text-muted mb-2"><i class="bi bi-hourglass-split text-danger"></i> Pendientes</h6>
            <h3 class="mb-0 text-danger">{{ stats.pendientes }}</h3>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card border-warning shadow-sm h-100">
          <div class="card-body">
            <h6 class="card-title text-muted mb-2"><i class="bi bi-arrow-repeat text-warning"></i> En Proceso</h6>
            <h3 class="mb-0 text-warning">{{ stats.en_proceso }}</h3>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card border-success shadow-sm h-100">
          <div class="card-body">
            <h6 class="card-title text-muted mb-2"><i class="bi bi-check-circle-fill text-success"></i> Cerrados (Total)</h6>
            <h3 class="mb-0 text-success">{{ stats.cerrados_hoy }}</h3>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card border-info shadow-sm h-100">
          <div class="card-body">
            <h6 class="card-title text-muted mb-2"><i class="bi bi-graph-up text-info"></i> SLA Cumplido</h6>
            <h3 class="mb-0 text-info">{{ stats.sla_cumplido }}%</h3>
          </div>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-lg-6 mb-4">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-white border-bottom">
            <h5 class="card-title mb-0"><i class="bi bi-pie-chart text-primary"></i> Tickets por Estado</h5>
          </div>
          <div class="card-body"><canvas id="chartEstado" height="250"></canvas></div>
        </div>
      </div>
      <div class="col-lg-6 mb-4">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-white border-bottom">
            <h5 class="card-title mb-0"><i class="bi bi-bar-chart text-primary"></i> Tickets por Categoría</h5>
          </div>
          <div class="card-body"><canvas id="chartCategoria" height="250"></canvas></div>
        </div>
      </div>
    </div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chartData = {{ chart_data|tojson }};
    
    // Gráfico de Tickets por Estado
    new Chart(document.getElementById('chartEstado'), {
      type: 'doughnut',
      data: {
        labels: chartData.estados_labels,
        datasets: [{
          data: chartData.estados_data,
          backgroundColor: ['#dc3545', '#ffc107', '#198754'], // Abierto, En Proceso, Cerrado
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });

    // Gráfico de Tickets por Categoría
    new Chart(document.getElementById('chartCategoria'), {
      type: 'bar',
      data: {
        labels: chartData.categorias_labels,
        datasets: [{
          label: 'Nº de Tickets',
          data: chartData.categorias_data,
          backgroundColor: 'rgba(13, 110, 253, 0.6)'
        }]
      },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });
});
</script>
{% endblock %}