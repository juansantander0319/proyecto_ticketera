{% extends "base.html" %}
{% block title %}Inventario de Activos - Ticketera{% endblock %}
{% block content %}
<div class="container-fluid fade-in">
  <main class="px-md-4 py-4">
    <h2 class="mt-4"><i class="bi bi-pc-display"></i> Inventario de Activos</h2>
    <p class="text-muted">Consulta y gestiona los equipos de la empresa.</p>

    <div class="mb-3 text-end"><button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevoActivo"><i class="bi bi-plus-circle"></i> Nuevo Activo</button></div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="GET" action="{{ url_for('tecnico_inventario') }}">
                <div class="row g-3 align-items-end">
                    <div class="col-md-5"><label class="form-label">Buscar por Tipo, Marca o Modelo</label><input type="search" name="search" class="form-control" value="{{ filters.search or '' }}"></div>
                    <div class="col-md-4"><label class="form-label">Asignado a</label><select name="asignado_a_id" class="form-select">
                        <option value="">Todos</option>
                        {% for usuario in usuarios %}<option value="{{ usuario.id }}" {% if usuario.id|string == filters.asignado_a_id %}selected{% endif %}>{{ usuario.nombre }}</option>{% endfor %}
                    </select></div>
                    <div class="col-md-3 d-flex">
                        <button type="submit" class="btn btn-primary me-2"><i class="bi bi-filter"></i> Filtrar</button>
                        <a href="{{ url_for('tecnico_inventario') }}" class="btn btn-secondary"><i class="bi bi-x-lg"></i> Limpiar</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle">
            <thead><tr><th>Tipo</th><th>Marca</th><th>Modelo</th><th>Serie</th><th>Asignado a</th><th>Acciones</th></tr></thead>
            <tbody>
              {% for activo in pagination.items %}
              <tr>
                <td>{{ activo.tipo }}</td>
                <td>{{ activo.marca }}</td>
                <td>{{ activo.modelo }}</td>
                <td>{{ activo.numero_serie }}</td>
                <td>{{ activo.asignado_a.nombre if activo.asignado_a else 'No asignado' }}</td>
                <td>
                  <button class="btn btn-sm btn-outline-primary edit-btn" data-bs-toggle="modal" data-bs-target="#modalEditarActivo"
                          data-id="{{ activo.id }}" data-tipo="{{ activo.tipo }}" data-marca="{{ activo.marca }}" data-modelo="{{ activo.modelo }}"
                          data-serie="{{ activo.numero_serie }}" data-asignado-id="{{ activo.asignado_a_id or '' }}">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger delete-btn" data-bs-toggle="modal" data-bs-target="#modalEliminarActivo" data-id="{{ activo.id }}"><i class="bi bi-trash"></i></button>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="6" class="text-center text-muted p-4">No se encontraron activos.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <nav class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}"><a class="page-link" href="{{ url_for('tecnico_inventario', page=pagination.prev_num, **filters) }}">Anterior</a></li>
                {% for page_num in pagination.iter_pages() %}
                    {% if page_num %}<li class="page-item {% if page_num == pagination.page %}active{% endif %}"><a class="page-link" href="{{ url_for('tecnico_inventario', page=page_num, **filters) }}">{{ page_num }}</a></li>{% endif %}
                {% endfor %}
                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}"><a class="page-link" href="{{ url_for('tecnico_inventario', page=pagination.next_num, **filters) }}">Siguiente</a></li>
            </ul>
        </nav>
      </div>
    </div>
  </main>
</div>

<div class="modal fade" id="modalNuevoActivo" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white"><h5 class="modal-title">Nuevo Activo</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <form action="{{ url_for('tecnico_inventario') }}" method="POST">
        <div class="modal-body">
          <div class="mb-3"><label class="form-label">Tipo</label><input type="text" class="form-control" name="tipo" required></div>
          <div class="mb-3"><label class="form-label">Marca</label><input type="text" class="form-control" name="marca"></div>
          <div class="mb-3"><label class="form-label">Modelo</label><input type="text" class="form-control" name="modelo"></div>
          <div class="mb-3"><label class="form-label">Número de Serie</label><input type="text" class="form-control" name="numero_serie"></div>
          <div class="mb-3"><label class="form-label">Asignado a</label>
            <select name="asignado_a_id" class="form-select">
              <option value="">No asignado</option>
              {% for usuario in usuarios %}<option value="{{ usuario.id }}">{{ usuario.nombre }}</option>{% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Guardar</button></div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="modalEditarActivo" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white"><h5 class="modal-title">Editar Activo</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <form action="{{ url_for('editar_activo') }}" method="POST">
        <div class="modal-body">
          <input type="hidden" name="id_activo_edit" id="id_activo_edit">
          <div class="mb-3"><label class="form-label">Tipo</label><input type="text" class="form-control" name="tipo_edit" id="tipo_edit" required></div>
          <div class="mb-3"><label class="form-label">Marca</label><input type="text" class="form-control" name="marca_edit" id="marca_edit"></div>
          <div class="mb-3"><label class="form-label">Modelo</label><input type="text" class="form-control" name="modelo_edit" id="modelo_edit"></div>
          <div class="mb-3"><label class="form-label">Número de Serie</label><input type="text" class="form-control" name="numero_serie_edit" id="numero_serie_edit"></div>
          <div class="mb-3"><label class="form-label">Asignado a</label>
            <select name="asignado_a_id_edit" id="asignado_a_id_edit" class="form-select">
              <option value="">No asignado</option>
              {% for usuario in usuarios %}<option value="{{ usuario.id }}">{{ usuario.nombre }}</option>{% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-primary">Actualizar</button></div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="modalEliminarActivo" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white"><h5 class="modal-title">Confirmar Eliminación</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <form action="{{ url_for('eliminar_activo') }}" method="POST">
        <div class="modal-body">
          <p>¿Estás seguro de que quieres eliminar este activo? Esta acción no se puede deshacer.</p>
          <input type="hidden" name="id_activo_delete" id="id_activo_delete">
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-danger">Eliminar</button></div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    var editModal = document.getElementById('modalEditarActivo');
    if (editModal) {
        editModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            document.getElementById('id_activo_edit').value = button.getAttribute('data-id');
            document.getElementById('tipo_edit').value = button.getAttribute('data-tipo');
            document.getElementById('marca_edit').value = button.getAttribute('data-marca');
            document.getElementById('modelo_edit').value = button.getAttribute('data-modelo');
            document.getElementById('numero_serie_edit').value = button.getAttribute('data-serie');
            document.getElementById('asignado_a_id_edit').value = button.getAttribute('data-asignado-id');
        });
    }

    var deleteModal = document.getElementById('modalEliminarActivo');
    if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            document.getElementById('id_activo_delete').value = button.getAttribute('data-id');
        });
    }
});
</script>
{% endblock %}